# TeamSpirit Assistant

TeamSpiritの打刻とホーム画面での勤怠情報表示を行うChrome拡張機能です。

## 機能

### ポップアップ打刻
- **ログイン機能**: 拡張機能から直接Salesforceにログイン（メールアドレスの保存可能）
- **バックグラウンド打刻**: TeamSpiritを開かずに出勤・退勤打刻
- **勤務場所の選択**: リモート、オフィス、直行→オフィス、オフィス→直帰、直行直帰
- **本日情報表示**: 今日が出勤日か休日かを表示（祝日名も表示）
- **打刻漏れ警告**: ヘッダーに警告アイコンを表示

### ホーム画面表示
打刻エリアの下に勤怠情報パネルを自動表示（5列構成）：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            打刻エリア（上部）                                │
│     2026/02/04  13:42    [リモート▼]              [出勤]  [退勤]            │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────┬───────────┬─────────────┬─────────────┬─────────────┐
│ 勤怠情報  │   時刻    │ 月間サマリー │  残業警告   │  打刻漏れ   │
├───────────┼───────────┼─────────────┼─────────────┼─────────────┤
│ 2/4 (火)  │現在 13:42 │所定: 144:00 │勤務日数: 3日│件数: 2件    │
│ 出勤日    │出勤 08:11 │総労働: 30:42│勤務時間:30:42│ 1/31 退    │
│ 状態:出勤中│勤務 05:31 │過不足:-113:18│平均/日: 15:21│ 2/3 出退   │
│           │目標 16:16 │残り: 16日   │残業/日: +4:36│             │
│           │           │必要: 7:05   │─────────────│             │
│           │           │             │8h超過: +9:11│             │
│           │           │             │月間残業: 0:00│            │
│           │           │             │残業上限:45:00│            │
│           │           │             │月末予測:+82:47│           │
└───────────┴───────────┴─────────────┴─────────────┴─────────────┘
```

### 時間表示・サマリー
- **リアルタイム更新**: 現在時刻、勤務時間、総労働時間、過不足時間
- **月間サマリー**: 所定労働時間、総労働時間、過不足時間
- **自動計算**: 残り勤務日数、一日当たり必要勤務時間、目標退勤時刻

### 残業警告
- **勤務実績表示**: 勤務日数、勤務時間、平均/日、残業/日
- **残業指標**: 8h超過累計（健康管理）、月間残業（法的）
- **月末予測**: 今のペースで残業を続けた場合の月末残業時間を予測
- **警告バッジ**: 45時間超過時は「超過中」、超過見込み時は「注意」を表示

### 打刻漏れ検出
- **自動検出**: 当月の打刻漏れを自動検出（前日分まで）
- **漏れ種別表示**: 出勤漏れ、退勤漏れ、両方漏れを識別
- **警告表示**: 打刻漏れがある場合、ヘッダーに警告アイコンを表示
- **クリックで展開**: 警告アイコンをクリックすると詳細を表示

## インストール方法

1. このリポジトリをクローンまたはダウンロード
2. Chromeで `chrome://extensions/` を開く
3. 右上の「デベロッパーモード」をオンにする
4. 「パッケージ化されていない拡張機能を読み込む」をクリック
5. ダウンロードしたフォルダを選択

## 使い方

### 初回ログイン
1. Chrome右上の拡張機能アイコンをクリック
2. メールアドレスとパスワードを入力
3. 「メールアドレスを保存」にチェックを入れてログイン

### 打刻
1. 拡張機能アイコンをクリック
2. 勤務場所を選択
3. 「出勤」または「退勤」ボタンをクリック

### ホーム画面表示
- TeamSpiritのホーム画面を開くと自動的に勤怠情報パネルが表示されます
- 情報は1秒ごとにリアルタイム更新されます

## 表示項目の説明

### ヘッダー部分

| 項目 | 説明 |
|------|------|
| **TeamSpirit** | 拡張機能のタイトル |
| **警告アイコン (!)** | 打刻漏れがある場合に表示される赤いバッジ。クリックで打刻漏れセクションへスクロール |

### 本日情報セクション

| 項目 | 説明 |
|------|------|
| **日付** | 今日の日付（例: 1/15） |
| **曜日** | 今日の曜日（例: (水)） |
| **祝日名** | 祝日の場合は祝日名を表示（例: 成人の日） |
| **出勤日/休日** | TeamSpiritの勤怠表データに基づく判定。出勤日なら青、休日ならグレー |

### 状態セクション

| 表示 | 意味 |
|------|------|
| **出勤中** | 今日出勤打刻済みで、退勤打刻がまだ |
| **退勤済み** | 今日の出勤・退勤両方打刻済み |
| **未出勤** | 今日の出勤打刻がまだ |
| **確認中...** | データ取得中 |

### 打刻セクション

| 項目 | 説明 |
|------|------|
| **勤務場所** | リモート/オフィス/直行→オフィス/オフィス→直帰/直行直帰 から選択 |
| **出勤ボタン** | 出勤打刻を実行。出勤中は無効化 |
| **退勤ボタン** | 退勤打刻を実行。未出勤時は無効化 |

### 時刻セクション（出勤中のみ表示）

| 項目 | 説明 |
|------|------|
| **現在時刻** | 現在の時刻（1秒ごとに更新） |
| **出勤時刻** | 今日の出勤打刻時刻 |
| **退勤時刻** | 今日の退勤打刻時刻（退勤済みの場合のみ表示） |
| **勤務時間** | 出勤からの経過時間（リアルタイム更新） |
| **目標退勤** | 「一日当たり必要時間 + 休憩1時間」を出勤時刻に加算した時刻 |

### 月間サマリーセクション

| 項目 | 説明 | 計算式 |
|------|------|--------|
| **所定労働時間** | 今月の所定労働時間 | TeamSpiritから取得 |
| **総労働時間** | 今月の累計労働時間（リアルタイム更新） | TeamSpirit値 + 今日の勤務時間 |
| **過不足時間** | 所定に対する過不足 | 総労働時間 - 所定労働時間 |
| **残り勤務日数** | 今月の残り出勤日数 | 所定出勤日数 - 実出勤日数 |
| **一日当たり必要** | 所定達成に必要な1日あたり労働時間 | (所定 - 総労働) ÷ 残り日数 |

### 残業警告セクション

#### 勤務実績

| 項目 | 説明 | 計算式 |
|------|------|--------|
| **勤務日数** | 当月の勤務日数（当日を含む） | TeamSpirit実出勤日数 + 1（今日出勤中の場合） |
| **勤務時間** | 当月の総勤務時間（リアルタイム更新） | TeamSpirit値 + 今日の勤務時間 |
| **平均/日** | 1日あたりの平均勤務時間 | 総勤務時間 ÷ 退勤済み日数 |
| **残業/日** | 1日あたりの平均残業時間 | 8h超過累計 ÷ 退勤済み日数 |

#### 残業指標

| 項目 | 説明 | 計算式 |
|------|------|--------|
| **8h超過累計** | 健康管理指標。各日の8時間超過分の合計 | Σ max(0, 各日の勤務時間 - 8時間) ※当日除く |
| **月間残業** | 法的な残業時間 | max(0, 総勤務時間 - 月間所定労働時間) |
| **残業上限** | 月間残業の上限時間（固定値） | 45:00 |
| **月末予測** | 今のペースで残業を続けた場合の月末残業時間 | 8h超過累計 + (残り勤務日数 × 残業/日) |

#### 警告レベル

| バッジ | 状態 | 条件 |
|--------|------|------|
| **超過中** | 既に45時間超過 | 月間残業 > 45時間 |
| **注意** | 超過見込み | 月末予測 > 45時間 |
| **正常** | 問題なし | 月末予測 ≤ 45時間 |

#### 残業/日の色分け

| 色 | 状態 | 条件 |
|----|------|------|
| 赤 | 危険 | 残業/日 ≥ 2時間 |
| オレンジ | 警告 | 残業/日 ≥ 1時間 |
| 黄色 | 注意 | 残業/日 > 0 |
| 緑 | 安全 | 残業/日 ≤ 0 |

### 打刻漏れセクション

| 項目 | 説明 |
|------|------|
| **件数** | 打刻漏れの件数（前日分まで判定） |
| **リスト** | 打刻漏れの日付と種別 |

#### 打刻漏れの種別

| ラベル | 意味 | 色 |
|--------|------|-----|
| **出** | 出勤打刻がない（退勤のみ） | 青 |
| **退** | 退勤打刻がない（出勤のみ） | オレンジ |
| **出退** | 出勤・退勤両方ない | 赤 |

## ファイル構成

```
teamspirit-assistant/
├── manifest.json        # 拡張機能の設定
├── popup.html           # ポップアップUI
├── popup.css            # ポップアップのスタイル
├── popup.js             # ポップアップのロジック
├── content.js           # ページ操作・パネル表示スクリプト
├── content-styles.css   # パネル表示用スタイル
├── background.js        # バックグラウンドサービス・データ取得
├── config.js            # 設定値（標準勤務時間、残業上限等）
├── utils.js             # ユーティリティ関数
├── overtime-calc.js     # 残業計算ロジック（共通）
├── crypto.js            # パスワード暗号化
├── login.js             # ログイン処理
├── punch.js             # 打刻処理
├── tab-utils.js         # タブ操作ユーティリティ
└── icons/               # アイコン画像
    ├── icon16.png
    ├── icon48.png
    └── icon128.png
```

## 注意事項

- メールアドレスはローカルに永続保存されます（チェックボックスがオンの場合）
- パスワードはAES-GCM暗号化してローカルに永続保存されます（チェックボックスがオンの場合）
- 2要素認証(2FA)には対応していません
- ホーム画面表示はTeamSpiritのページ構造に依存しています

## 更新履歴

### v3.3.0
- 残業警告セクションの計算ロジックを改善
  - 残業/日: 日次残業方式に変更（各日の(勤務時間-8時間)の合計÷退勤済み日数）
  - 平均/日: 退勤済み日数で計算するよう修正
  - 当日を計算から除外（退勤打刻済み日数で計算）
- 月間残業と8h超過累計を項目分離
  - 月間残業（法的）: max(0, 総勤務時間 - 月間所定労働時間)
  - 8h超過累計（健康管理）: 各日の8時間超過分の合計
- 月末予測のロジックを改善（8h超過累計 + 残り勤務日数 × 残業/日）
- 勤務日数表示の不整合を修正
- コードをモジュール分割（overtime-calc.js, utils.js, config.js等）

### v3.2.0
- 本日情報表示機能を追加（出勤日/休日、祝日名）
- 打刻漏れ検出機能を追加（前日分まで）
- ヘッダー警告アイコンを追加
- データ取得を統合し、タブ1つで全データを取得するよう最適化
- UIレイアウトを改善

### v3.1.0
- パスワード暗号化（AES-GCM）に対応
- SPAナビゲーション対応を改善

### v3.0.0
- TeamSpirit Assistantとして統合
- ホーム画面パネル表示機能を追加
